# ApigilityLogic Distribution 分销组件
提供基本的分销功能。主要包含两部分：
- **_分销链管理_** 管理用户与用户之间的分销上下级关系。
- **_分销策略管理_** 管理分销规则，分销规则指的是，当一笔交易完成时，
  分销链中的用户如何分配特定的利润值。

## 分佣模式

### 链级分佣
在分销链中，任意一个节点产生交易额，都可以取交易额的一个特定百分比来进行链级分佣。
这个特定的百分比称为`链级分佣基准比例`。

由产生交易额的节点开始，它的上一级节点称为`一级分佣者`，一级分佣者的上一级节点称为`二级分佣者`，
二级分佣者的上一级节点称为`三级分佣者`，如此类推。

各级分佣者得到的分佣，由各级的`等级比例`来确定， 但*等级比例*是在*基准比例*的基础上进行计算的。

> #### 举例
> - 基准比例是 10%
> - 一级比例是 50%
> - 二级比例是 30%
> - 三级比例是 20%
> 
> 当成交额为 100 时，各级分佣者拿到的分佣额分别是：
> - 一级： 100 * 10% * 50% = 5
> - 二级： 100 * 10% * 30% = 3
> - 三级： 100 * 10% * 20% = 2

### 团队分佣
在分销链中，节点被区别为`普通节点`和`领导节点`。每个节点都可以在普通节点和领导节点之间切换。
在团队分佣的模式下，只有领导节点能够获得分佣。

当任意一个节点产生交易额时，都可以取交易额的一个特定百分比来进行团队分佣。
这个特定的百分比称为`团队分佣基准比例`。

领导节点又被具体为多个级别类型，领导节点可以在这些级别之间切换。这些级别是按高低顺序排列的，并且每个级别类型，
都对应着不同的`等级分佣比例`。这些等级分佣比例，必须符合一定的规则：

- 最高等级的比例是 100%
- 高等级必须比低等级的比例大，等级之间的比例差，叫`级差`

各级分佣者得到的分佣，按照固定的`团队分佣算法`来计算：

> #### 团队分佣算法
> 假设`团队分佣基准比例`是10%，并有如下5个领导节点等级：
> - 五星级 100%
> - 四星级 60%
> - 三星级 40%
> - 两星级 20%
> - 一星级 10%
> 
> 假设某一个节点发生一笔成功交易，发生额是100。
> 这时`团队分佣额`为 `100 * 10% = 10`。这个分佣额将在接下来的`团队分佣过程`中，
> 由找到的各级领导节点瓜分。
> 
> ##### _团队分佣过程_
> 1. 某节点发生交易。
> 2. 往上查找领导节点，如果到达分销链顶点则转到步骤7，否则继续步骤3。
> 3. 如果是首次遇到领导节点，那么跳到步骤4，否则跳到步骤5。
> 4. 直接分佣，分佣额为 `团队分佣额 * 当前领导节点级别分佣比例`。转到步骤2。
> 5. 如果当前领导节点的级别与上一次遇到的同级或级别更低，转到步骤2，否则继续步骤6。
> 6. 非首次分佣，分佣额为 `团队分佣额 * 当前领导节点级别与上一次找到的领导节点级别的级差`。转到步骤2。
> 7. 结束。
>
> 假设现有如下分销链：
> ```
> A(五星)
> |-- B1
> |-- B2(三星)
> |   |-- C1
> |   |-- C2(四星)
> |   |   |-- D1
> |   |   |-- D2
> |   |   `-- D3
> |   `-- C3
> `-- B3
> ```
> 假设交易发生在`D3`节点，那么`C2`节点分佣为`100 * 10% * 60% = 6`，
> `A`节点分佣为`100 * 10% * (100%-60%)= 4`，
> `B2`节点无分佣。

## 数据结构（Doctrine实体类）
- `Distributor` 分销者，用于管理分销链
- `Leader` 领导节点（团队分佣模式）
- `LeaderStatus` 领导节点类型（团队分佣模式）
- `ChainLevel` 分佣链级（链式分佣模式）
- `Event` 分佣事件，关联多个分佣项
- `Commission` 分佣项

如果要了解实体类的详细属性，以及各实体之间的关联关系，
请阅读[DoctrineEntity](src/DoctrineEntity)命名空间中的代码，
同时可以分析文档中提供的[MySQL Workbench ER图](docs/apigility-logic-distribution.mwb)来帮助理解。