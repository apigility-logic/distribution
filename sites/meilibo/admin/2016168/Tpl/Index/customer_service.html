<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=7" />
<title>美丽播 - 后台管理中心</title>
<link href="__PUBLIC__/statics/css/reset.css" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/statics/css/system.css" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/statics/css/table_form.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/meilibo/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="__PUBLIC__/statics/css/style/styles1.css" title="styles1" media="screen" />
<link rel="alternate stylesheet" type="text/css" href="__PUBLIC__/statics/css/style/styles2.css" title="styles2" media="screen" />
<link rel="alternate stylesheet" type="text/css" href="__PUBLIC__/statics/css/style/styles3.css" title="styles3" media="screen" />
<link rel="alternate stylesheet" type="text/css" href="__PUBLIC__/statics/css/style/styles4.css" title="styles4" media="screen" />	
<link rel="stylesheet" type="text/css" href="__PUBLIC__/statics/css/customer.css">

<script language="javascript" type="text/javascript" src="http://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<script language="javascript" type="text/javascript" src="__PUBLIC__/statics/js/admin_common.js"></script>
<script language="javascript" type="text/javascript" src="__PUBLIC__/statics/js/styleswitch.js"></script>
<script type="text/javascript">
	window.focus();
	</script>
</head>
<body>
   <div class="mainbox">
	<div class="chatbox">
		<!-- 聊天部分 -->
		<div class="chat fl">
			<div class="username"></div>
			<!-- 聊天消息 -->
			<div class="chat_top">
				
				<!-- 聊天记录 -->
				<!-- <div class="chat_record">
					<div class='chat_title'><span>近三天的聊天记录</span></div>
				</div> -->
			</div>
			<!-- 聊天发送 -->
			<div class="chat_bottom">
				<!-- <button class="fr btn btn-default">|</button>	 -->
				<div class="chat_tool">
					<span class="clearpic" title="清空" onclick="clearText()"><img src="__PUBLIC__/statics/images/clear.png"></span>
					<a class="fr btn btn-default" id="chat_record_button"><img src='__PUBLIC__/statics/images/jilu.png' style='margin-bottom:2px;'>消息记录</a>	
				</div>
				<textarea id="msg"></textarea>
				<div class="chatmsgBtn"><a class="fr btn btn-info" onclick="sendSingleMsg()">发送</a></div>
			</div>
		</div>
		<!-- 消息人队列 -->
		<div class="msg_person fr"></div>
	</div>
   </div>
<!-- js部分 -->
<script src='__PUBLIC__/statics/js/jmessage-sdk-web-2.1.0.min.js'></script>
<script src='__PUBLIC__/statics/js/md5.js'></script>
<script src='__PUBLIC__/statics/js/jquery.base64.js'></script>
<script type="text/javascript">
    var wh=$(window).height();
  	$(".mainbox").height(wh-80);
	$(".chat_top").height(wh-80-205);
    var size = 10;

	var thisNewDate = 0;
	var thisOldDate = 0;
	//init
    var appkey = "d6c4ba516dc1702bf597fd3d";
    var random_str = "022cd9fd995849b58b3ef0e943421ed9";
    var timestamp = new Date().getTime();
    var secret = "b67b8a6bc75420df78cb3799";
    var signature = MD5("appkey="+appkey+"&timestamp="+timestamp+"&random_str="+random_str+"&key="+secret);
    var MEDIA_URL = "http://media.file.jpush.cn/";
    var apiHost = "http://demo.meilibo.net";
    var username = 'system_service';
    var userinfo = new Array();
	var chat_record = new Array();
	var chat_line='';
    var recordScrollHeight = 0;
    window.JIM = new JMessage({
        debug : false,
    });
    $(function(){
    	init();
    	document.onkeydown=function(event){
    		var e = event || window.event || arguments.callee.caller.arguments[0];
    		if(e && e.keyCode==13){sendSingleMsg(e); }
    	}
    	$(document).on("click","#chat_record_button",function(){
    		if( !chat_record.hasOwnProperty( $(".msg_person .active").attr('data-name') ) ){
	    		$.ajax({
	    			url:apiHost+'/OpenAPI/v1/jmessage/getChatMsg',
	    			type:'get',
	        		dataType:'jsonp',  
	    			jsonp:'callback', 
	    			data:{'username':username,'targetuser':$(".msg_person .active").attr('data-name')},
	    			beforeSend:function(){
	    				$(".chat_top div[data-name='"+$(".msg_person .active").attr("data-name")+"'] > p").html("<span id='chat_record_button'><img src='__PUBLIC__/statics/images/loading.gif' style='width:25px;margin-bottom:2px;'></span>");
	    			},
	    			success:function(res){
                        console.log(res);
	    				$(".chat_top div[data-name='"+$(".msg_person .active").attr("data-name")+"'] > p").html("<span id='chat_record_button'><img src='__PUBLIC__/statics/images/jilu2.png' style='margin-bottom:2px;'>查看更多消息</span>");
						chat_record[$(".msg_person .active").attr('data-name')] = res.data[$(".msg_person .active").attr('data-name')];
                        chat_record[$(".msg_person .active").attr('data-name')].page = 1;
                        chat_record[$(".msg_person .active").attr('data-name')].pageCount = Math.ceil( chat_record[$(".msg_person .active").attr('data-name')].total/size );
						chatRecord( chat_record[$(".msg_person .active").attr('data-name')].page , size);
						console.log(chat_record[$(".msg_person .active").attr('data-name')]);
	    			}
	    		})
    		}else{
                chat_record[$(".msg_person .active").attr('data-name')].page++;
                if( chat_record[$(".msg_person .active").attr('data-name')].page <= chat_record[$(".msg_person .active").attr('data-name')].pageCount ){
                    var i = chat_record[$(".msg_person .active").attr('data-name')].page * size - chat_record[$(".msg_person .active").attr('data-name')].total;
                    chatRecord( chat_record[$(".msg_person .active").attr('data-name')].page , i > 0 ? size - i : size);
                }else{
                    $(".chat_top div[data-name='"+$(".msg_person .active").attr("data-name")+"'] > p").remove();
                    if($(".chat_top .nomsg").length==0){
                    	$(".chat_top div[data-name='"+$(".msg_person .active").attr("data-name")+"']").prepend("<div class=\"cf nomsg\">没有更多消息了</div>");
                    }
                    
                }

                // console.log(chat_record);
    		}
    		// changeDispaly();
    		// $(".chat_top div[data-name='"+$(".msg_person .active").attr('data-name')+"']").toggle();
    	
    	})
    	
    	$(document).on("click",".audio_msg",function(){
    		var audio = $(this).children("audio")[0];
    		audio.play();
    	});
    })
    function changeDispaly(){
    		var display = $(".chat_record")[0];
    		if( display.style.display == "block"){
    			$(".chat_record").css('display', 'none');
    		}else{
    			$(".chat_record").css('display', 'block');
    		}
    }
    function init() {
        JIM.init({
            "appkey": appkey,
            "random_str": random_str,
            "signature": signature,
            "timestamp": timestamp
        }).onSuccess(function(data) {
            // console.log('success:' + JSON.stringify(data));
            login();
        }).onFail(function(data) {
            console.log('error:' + JSON.stringify(data))
        });
    }
	
    function loginOut(){
	     JIM.loginOut();
	}
    function login() {
        JIM.login({
            'username' : username,
            'password' : '123456'
        }).onSuccess(function(data) {
        	getUser();
            console.log('loginsuccess:' + JSON.stringify(data));
            JIM.onMsgReceive(function(data) {
            	var username = data.messages[0].content.from_id;
            	getSelfInfo( data, username , 1) ;
                // console.log('msg_receive->' + userinfo);
	            // addUser( userinfo );
                data = JSON.stringify(data);
                // console.log('msg_receive:' + data);
	            //添加右侧
            });

            JIM.onEventNotification(function(data) {
                console.log('event_receive: ' + JSON.stringify(data));
            });
        }).onFail(function(data) {
            console.log('error:' + JSON.stringify(data));
        }).onTimeout(function(data) {
            console.log('timeout:' + JSON.stringify(data));
        });
    }
    function getUser(){
		JIM.getConversation().onSuccess(function(data) {
          // do something
          	// console.log("user",data);
          	var messages = "";
          	for (var key in data['conversations']) {
          		// console.log(data['conversations'][key].name);
        		getSelfInfo( messages, data['conversations'][key].name , 2);
          	}
       	}).onFail(function(data) {
          console.log("error",data);
       	});
    }
    function getSelfInfo( messages, username , type) {
        JIM.getUserInfo({
            'username' : username
        }).onSuccess(function(data) {
            // console.log('success:' + data.user_info.avatar);
            // data = data
            if( data.user_info.avatar ){
	            if( type == 1 ){
	            	addUser( data );
	            	ReceiveMessage( data, messages );
	            }
	            if( type == 2 ){
	            	addUser( data );
	            }
            }
            // return JSON.stringify(data);
        }).onFail(function(data) {
            console.log('error:' + JSON.stringify(data));
        });
		
    }


    function sendSingleMsg() {
    	var content = $("#msg").val();
    	// alert(content);
    	if( $(".msg_person .active").length > 0 && content.length > 0 ){
	    	var username = $(".msg_person .active").attr("data-name");
	    	var nickname = $(".msg_person .active").attr("data-nick");
	    	// console.log(username, nickname);
	        JIM.sendSingleMsg({
	            'target_username' : username,
				'target_nickname' : nickname,
	            'content' : content,
	            'appkey' : appkey
	        }).onSuccess(function(data) {
	            // console.log('success:' + JSON.stringify(data));
	            $(".chat_record").css("display", "none");
	            $("div[data-name='"+$(".msg_person .active").attr("data-name")+"']").show();
	            SendMessage();
	        }).onFail(function(data) {
	            console.log('error:' + JSON.stringify(data));
	        });
        }else{
        	alert("未选择接收人或未填写发送信息！");
        }
    }
    function addUser( data ){
    	if( !userinfo.hasOwnProperty(data.user_info.username) ){
	    	userinfo[data.user_info.username] = data.user_info;
	    	var $html = "<div class=\"msg_person_list\" data-name=\""+data.user_info.username+"\" data-nick=\""+data.user_info.nickname+"\" onclick=\"clickUser(this)\" >"+
					"<div class=\"msg_person_list_avatar fl\"><img src=\""+MEDIA_URL+data.user_info.avatar+"\" /></div>"+
					"<div class=\"msg_person_list_nickname fl\">"+data.user_info.nickname+"</div>"+
				"</div>";
			$(".msg_person").append($html);
			var datanick = $(".msg_person .active").attr('data-nick');
    		$(".username").text(datanick);
			$(".msg_person .msg_person_list").eq(0).addClass("active");
			if( $(".chat_top").children("div[data-name='"+$(".msg_person .active").attr("data-name")+"']").length == 0 ){
			$(".chat_top").append("<div data-name=\""+$(".msg_person .active").attr("data-name")+"\"><p><span id='chat_record_button'><img src='__PUBLIC__/statics/images/jilu2.png' style='margin-bottom:2px;'>查看更多消息</span></p></div>");
				}
    }
  }
    function clickUser(event){
		$(".chat_record").css('display', 'none');
    	$this = $(event);
    	var username = $this.attr('data-name');
    	var datanick = $this.attr('data-nick');
    	$(".username").text(datanick);
    	$this.addClass('active');
    	$this.siblings().removeClass('active');
		$this.children(".msg_person_list_sign").remove();
		$("#chat_record_button").show();
		if( $(".chat_top").children("div[data-name='"+$(".msg_person .active").attr("data-name")+"']").length == 0 ){
			$(".chat_top").append("<div data-name=\""+$(".msg_person .active").attr("data-name")+"\"><p><span id='chat_record_button'><img src='__PUBLIC__/statics/images/jilu2.png' style='margin-bottom:2px;'>查看更多消息</span></p></div>");
			// $(".chat_top").children("div[data-name='"+userinfo.user_info.username+"']").css('display','none');
		}
    	$(".chat_top").children("div[data-name='"+username+"']").css('display','block');
		$(".chat_top").children("div[data-name='"+username+"']").siblings().css('display','none');
    }
    function ReceiveMessage( userinfo, data ){

    	var msg;
    	switch(data.messages[0].content.msg_type){
    		case "image" :
    			msg = "<img height=\""+data.messages[0].content.msg_body.height+"\" width=\""+data.messages[0].content.msg_body.width+"\" src=\""+data.messages[0].content.msg_body.media_url+"\"/>";
    			break;
    		case "text" : 
    			msg = data.messages[0].content.msg_body.text;
    			break;
    		case "voice" : 

    			msg = "<div class=\"audio_msg\">"
					+"<div class=\"fl audio_msg_img\"><img src=\"__PUBLIC__/statics/images/voice.png\" height=\"20px\" width=\"20px\" /></div>"
					+"<audio src=\""+data.messages[0].content.msg_body.media_url+"\" style=\"display: none\" controls=\"controls\" >您的浏览器不支持 audio 标签。</audio>"
					+"<div class=\"fr audio_msg_text\">  </div>"
				+"</div>";
    			break;
    		default :
	    		msg = ""; 
	    		break;
    	}

    	var nowDate = Date.parse(new Date());
    	var time = "";
    	if( ( nowDate - thisNewDate ) > 30000 ){
    		time = new Date().Format("yyyy-MM-dd hh:mm");
    		thisNewDate = nowDate;
    	}
    	var $html ="<div class=\"cf\">"+time+"</div>"
    				+"<div class=\"chat_top_msg\">"
					+"<div class=\"msg_person_list_avatar fl\" style='margin-top:10px;'><img src=\""+MEDIA_URL+userinfo.user_info.avatar+"\"></div>"
					+"<div class=\"chat_top_msg_box fl\">"
						+"<div class=\"chat_top_msg_name fl\">"+userinfo.user_info.nickname+"</div>"
						+"<div class=\"cf\" style='height:28px;padding-top:0;'>"
						+"<div class=\"chat_top_msg_content_sign_left fl\"></div>"
						+"<div class=\"chat_top_msg_receive_content fl\">"+msg+"</div></div>"
					+"</div>"
				+"</div>";
		if( $(".chat_top").children("div[data-name='"+userinfo.user_info.username+"']").length == 0 ){
			$(".chat_top").append("<div data-name=\""+userinfo.user_info.username+"\"></div>");
			$(".chat_top").children("div[data-name='"+userinfo.user_info.username+"']").css('display','none');
		}
		// console.log($(".chat_top").children("div[data-name='"+userinfo.user_info.username+"']").children(".msg_person_list_sign").length);
		if( !$(".msg_person").children("div[data-name='"+userinfo.user_info.username+"']").hasClass("active") ){
			if( $(".msg_person").children("div[data-name='"+userinfo.user_info.username+"']").children(".msg_person_list_sign").length > 0 ){
				if( parseInt( $(".msg_person").children("div[data-name='"+userinfo.user_info.username+"']").children(".msg_person_list_sign").html() ) >= 99 ){
					$(".msg_person").children("div[data-name='"+userinfo.user_info.username+"']").children(".msg_person_list_sign")
					.html("99+").css({'width':'30px','border-radius':'10px'});
				}else{
					$(".msg_person").children("div[data-name='"+userinfo.user_info.username+"']").children(".msg_person_list_sign")
					.html( parseInt( $(".msg_person").children("div[data-name='"+userinfo.user_info.username+"']").children(".msg_person_list_sign").html() )+1 );
				}
			}else{
				$sign = "<div class=\"msg_person_list_sign fr\">1</div>"
				$(".msg_person").children("div[data-name='"+userinfo.user_info.username+"']").append($sign);
			}
		}

		// if( $(".chat_top").children().attr("data-name") != userinfo.user_info.username ){
			
		// }
		$(".chat_top").children("div[data-name='"+userinfo.user_info.username+"']").append($html);
		scrollFunc( $(".chat_top").children("div[data-name='"+userinfo.user_info.username+"']") );
    }
    function SendMessage( data ){
		var nowDate = Date.parse(new Date());
    	var time = "";
    	var msg = $("#msg").val();
    	if( ( nowDate - thisNewDate ) > 30000 ){
    		time = new Date().Format("yyyy-MM-dd hh:mm");
    		thisNewDate = nowDate;
    		var $html ="<div class=\"cf chat_time\"><span>"+time+"</span></div>"
    				+"<div class=\"chat_top_msg\">"
					+"<div class=\"msg_person_list_avatar fr\"><img src=\"/style/avatar/0/0_big.jpg\"></div>"
					+"<div class=\"chat_top_msg_box fr\">"
						+"<div class=\"chat_top_msg_content_sign_right fr\"></div>"
						+"<div class=\"chat_top_msg_send_content fr\">"+msg+"</div>"
					+"</div>"
				+"</div>";
    	}else{
    		var $html ="<div class=\"chat_top_msg\">"
					+"<div class=\"msg_person_list_avatar fr\"><img src=\"/style/avatar/0/0_big.jpg\"></div>"
					+"<div class=\"chat_top_msg_box fr\">"
						+"<div class=\"chat_top_msg_content_sign_right fr\"></div>"
						+"<div class=\"chat_top_msg_send_content fr\">"+msg+"</div>"
					+"</div>"
				+"</div>";
    	}
    	
		if( $(".chat_top").children("div[data-name='"+$(".msg_person .active").attr("data-name")+"']").length == 0 ){
			$(".chat_top").append("<div data-name=\""+$(".msg_person .active").attr("data-name")+"\"></div>");
		}
		$(".chat_top").children("div[data-name='"+$(".msg_person .active").attr("data-name")+"']").append($html);
		$(".chat_bottom textarea").val("").focus();
		scrollFunc( $(".chat_top").children("div[data-name='"+$(".msg_person .active").attr("data-name")+"']") );
    } 
    function pagination( name, page, size) {
        return chat_record[name].messages.reverse().slice( ((page-1)*size), page*size );
    }
    function chatRecord( page, size){
        recordScrollHeight = $(".chat_top div[data-name='"+$(".msg_person .active").attr("data-name")+"'] ")[0].scrollHeight;
        var messages = pagination( $(".msg_person .active").attr('data-name') , page, size);
		for (var key in messages) {
			var message = messages[key];
	    	if( message.from_id == username ){
	    		addSend(message);
	    	}else{
	    		addReceive(message);
	    	}
		}

    }
    function addReceive( data ){
    	var msg;
    	switch(data.msg_type){
    		case "image" :
    			msg = "<img height=\""+data.msg_body.height+"\" width=\""+data.msg_body.width+"\" src=\""+MEDIA_URL+data.msg_body.media_id+"\"/>";
    			break;
    		case "text" : 
    			msg = data.msg_body.text;
    			break;
    		case "voice" : 
    			msg = "<div class=\"audio_msg\">"
					+"<div class=\"fl audio_msg_img\"><img src=\"__PUBLIC__/statics/images/voice.png\" height=\"20px\" width=\"20px\" /></div>"
					+"<audio src=\""+MEDIA_URL+data.msg_body.media_id+".mp3\" style=\"display: none\" controls=\"controls\" >您的浏览器不支持 audio 标签。</audio>"
					+"<div class=\"fr audio_msg_text\"> "+data.msg_body.duration+"S </div>"
				+"</div>";
    			break;
    		default :
	    		msg = ""; 
	    		break;
    	}
		var nowDate = data.msg_ctime;
    	var time = "";
    	if( ( thisOldDate - nowDate) > 30000 ){
    		time = new Date(data.msg_ctime).Format("yyyy-MM-dd hh:mm");
    		
    	}
    	thisOldDate = nowDate;
    	var $html = "<div class=\"cf\">"+time+"</div>"
				+"<div class=\"chat_top_msg\">"
				+"<div class=\"msg_person_list_avatar fl\" style='margin-top:10px;'><img src=\""+MEDIA_URL+userinfo[$(".msg_person .active").attr('data-name')].avatar+"\"></div>"
				+"<div class=\"chat_top_msg_box fl\">"
					+"<div class=\"chat_top_msg_name fl\">"+data.from_name+"</div>"
					+"<div class=\"cf\" style='height:28px;padding-top:0;'>"
					+"<div class=\"chat_top_msg_content_sign_left fl\"></div>"
					+"<div class=\"chat_top_msg_receive_content fl\">"+msg+"</div></div>"
				+"</div>"
				+"</div>";
		if( $(".chat_top").children("div[data-name='"+data.from_id+"']").length == 0 ){
			$(".chat_top").append("<div data-name=\""+data.from_id+"\"></div>");
			$(".chat_top").children("div[data-name='"+data.from_id+"']").css('display','none');
		}
		$(".chat_top div[data-name='"+$(".msg_person .active").attr("data-name")+"'] > p").after($html);
		scrollFuncAdd( $(".chat_top div[data-name='"+$(".msg_person .active").attr("data-name")+"'] ") );
    }
    function addSend( data ){
		var msg = data.msg_body.text;
		// console.log(data);
		var nowDate = data.msg_ctime;
    	var time = "";
    	if( ( thisOldDate - nowDate ) > 30000 ){
    		time = new Date(data.msg_ctime).Format("yyyy-MM-dd hh:mm");
    	}
    	thisOldDate = nowDate;
    	var $html = "<div class=\"cf\">"+time+"</div>"
    				+"<div class=\"chat_top_msg\">"
					+"<div class=\"msg_person_list_avatar fr\"><img src=\"/style/avatar/0/0_big.jpg\"></div>"
					+"<div class=\"chat_top_msg_box fr\">"
						+"<div class=\"chat_top_msg_content_sign_right fr\"></div>"
						+"<div class=\"chat_top_msg_send_content fr\">"+msg+"</div>"
					+"</div>"
				+"</div>";
		$(".chat_top div[data-name='"+$(".msg_person .active").attr("data-name")+"'] > p").after($html);
        scrollFuncAdd( $(".chat_top div[data-name='"+$(".msg_person .active").attr("data-name")+"'] ") );
    }

    function clearText(){
    	$(".chat_bottom textarea").val("");
    }
    function scrollFunc(event){
        event.scrollTop( event[0].scrollHeight );
    }
    function scrollFuncAdd(event){
    	event.scrollTop( event[0].scrollHeight - recordScrollHeight );
    }

 
    // 对Date的扩展，将 Date 转化为指定格式的String
	// 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符， 
	// 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字) 
	// 例子： 
	// (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423 
	// (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18 
	Date.prototype.Format = function (fmt) { //author: meizz 
	    var o = {
	        "M+": this.getMonth() + 1, //月份 
	        "d+": this.getDate(), //日 
	        "h+": this.getHours(), //小时 
	        "m+": this.getMinutes(), //分 
	        "s+": this.getSeconds(), //秒 
	        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
	        "S": this.getMilliseconds() //毫秒 
	    };
	    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
	    for (var k in o)
	    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
	    return fmt;
	}
</script>
</body>
</html>
